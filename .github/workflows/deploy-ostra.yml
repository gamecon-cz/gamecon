name: Deploy OSTRA (main) on direct push or merged pull request

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start containers
        run: docker compose up --build --detach

      - name: Dump optimized Composer classmap
        run: docker compose exec --no-TTY web composer dump-autoload --optimize

      - name: Run tests in container
        run: docker compose exec --no-TTY web php ./vendor/bin/phpunit

      - name: Upload test output as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: php-test-logs
          path: ./tests/logs

      - name: Deploy via FTP
        # testy provádíme zvlášť, abychom neměli output z deploye moc dlouhý
        # pozor změnu CRON_KEY je nutné provést i v https://console.cron-job.org
        run: |
          docker compose exec --no-TTY \
            -e FTP_DIR=ostra \
            -e FTP_BASE_URL="${{ secrets.FTP_BASE_URL }}" \
            -e DB_USER="${{ secrets.OSTRA_DB_USER }}" \
            -e DB_PASS="${{ secrets.OSTRA_DB_PASS }}" \
            -e DB_NAME="${{ secrets.OSTRA_DB_NAME }}" \
            -e DB_SERV=localhost \
            -e DBM_USER="${{ secrets.OSTRA_DBM_USER }}" \
            -e DBM_PASS="${{ secrets.OSTRA_DBM_PASS }}" \
            -e MIGRACE_HESLO="${{ secrets.OSTRA_MIGRACE_HESLO }}" \
            -e SECRET_CRYPTO_KEY="${{ secrets.OSTRA_SECRET_CRYPTO_KEY }}" \
            -e CRON_KEY="${{ secrets.OSTRA_CRON_KEY }}" \
            -e GOOGLE_API_CREDENTIALS="${{ secrets.OSTRA_GOOGLE_API_CREDENTIALS }}" \
            -e FIO_TOKEN="${{ secrets.OSTRA_FIO_TOKEN }}" \
            -e MAILER_DSN="${{ secrets.MAILER_DSN }}" \
            -e DB_ANONYM_SERV="${{ secrets.DB_ANONYM_SERV }}" \
            -e DB_ANONYM_USER="${{ secrets.DB_ANONYM_USER }}" \
            -e DB_ANONYM_PASS="${{ secrets.DB_ANONYM_PASS }}" \
            -e DB_ANONYM_NAME="${{ secrets.DB_ANONYM_NAME }}" \
            web php ./udrzba/nasad.php --skip-tests
