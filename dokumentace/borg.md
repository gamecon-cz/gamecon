# Zálohy databáze

Externí zálohy jsou prováděny pomocí nástroje [Borg](https://www.borgbackup.org/). Pro snadnější interakci je možné použít [Borgmatic](https://torsion.org/borgmatic/), jehož konfigurace sídlí ve složce *backup* a který celý proces výrazně zjednodušuje. Jelikož je přístup k produkčním datům omezen na protokol FTP, je navíc k synchronizaci dat využit [rclone](https://rclone.org/), který umí udělat přesnou kopii dat a podporuje různé síťové protokoly, včetně FTP. Jeho konfigurace je možná buď interaktivně se zadáním potřebných položek pro přístup k FTP, nebo z řádky spuštěním příkazu `rclone config create gamecon ftp host=$RCLONE_HOST user=$RCLONE_USER pass=$RCLONE_PASS explicit_tls=true`. O samotné spuštění synchronizace se již stará Borgmatic. Soubory k synchronizaci je možné vybrat v souboru *backup-list.txt*, který obsahuje seznam filtrovacích pravidel pro rclone. Dále je potřeba nastavit proměnná `FTP_DIR`, která určuje, ze které se složky se zálohy provádí (v běžném použití bude tato proměnná obsahovat řetězec *ostra*)

Pro připojení k samotnému repositáři se zálohami je potřeba nastavit několik dalších proměnných: `BORG_REPO` obsahuje adresu repositáře. Repositář je šifrovaný, heslo ke klíči je obsaženo v proměnné `BORG_PASSPHRASE`. Přístup k repositáři je nastaven pouze pro specifický SSH klíč (jeho privátní část je v proměnné `BORG_SSHKEY`).

Manuální operace s repositářem (například v případě potřeby obnovy dat) lze provést opět jednoduše pomocí nástroje Borgmatic, konfiguračního souboru ze složky *backup* a souboru s potřebnými proměnnými prostředí. Nejprve naimportujeme prostředí `source secrets.env`, poté můžeme vypsat seznam provedených záloh `borgmatic --config borgmatic.yaml list` a provést rozbalení vybraného archivu, např. z druhého listopadu 2022 `borgmatic --config borgmatic.yaml extract gamecon-2022-11-02`. Poté již ručně nebo pomocí `rclone copy` můžeme soubory nakopírovat na FTP, je-li to potřeba. Více, viz odpovídající manuály. Poznámka na okraj, pro správnou funkci je vhodné mít rclone alespoň ve verzi 1.60, borg 1.2 a borgmatic 1.7.
